# 分镜生成优化方案（不限损耗版）

## 当前问题
- 大量分镜（>25个）时，单次请求容易超时（Failed to fetch）
- 输出 token 限制导致无法满足用户的大量分镜需求

## 已实施的优化

### 1. 增加超时时间
- Claude API: 从 5分钟提升到 10分钟（600秒）
- OpenAI API: 从 5分钟提升到 10分钟（600秒）
- 可配置超时参数 `timeoutMs`

### 2. 增加输出限制
- Claude API: `max_tokens` 从 16384 提升到 32768
- 足以支持 40-50 个详细分镜的输出

### 3. 改进错误提示
- 超时错误提示具体的分钟数
- 网络错误给出详细的解决建议

## 进一步优化策略（可选实施）

### 方案一：分段生成（推荐）⭐

**原理**: 将大量分镜拆分成多个小批次，每批生成 15-20 个分镜

**优点**:
- 每个请求更快完成，不易超时
- 用户可以看到进度反馈
- 失败时只需重试失败的批次
- 理论上无上限（可生成 50、100、200 个分镜）

**实现要点**:
1. 先将剧本智能分割成 N 段（基于情节转折点）
2. 为每段生成对应的分镜（12-18个）
3. 传递前文分镜作为上下文，保证连贯性
4. 自动重新编号确保顺序正确

**成本**: 约为常规方式的 1.2-1.5 倍（因为有上下文重复）

**适用场景**:
- 分镜数 > 25 个
- 长剧本（>5000字）

### 方案二：使用更强模型

**模型推荐**:
- `claude-opus-4-5-20251101` - 最强推理能力，单次可处理更多分镜
- `claude-sonnet-4-5-20250929` - 性价比最高（当前使用）

**优点**:
- 输出质量更高
- 更准确理解复杂剧情
- 更强的长文本处理能力

**成本**: Opus 约为 Sonnet 的 3-5 倍

### 方案三：流式输出（体验优化）

**原理**: 使用 Server-Sent Events (SSE) 实时获取生成进度

**优点**:
- 用户可以实时看到分镜生成
- 避免等待焦虑
- 即使中断也能保留部分结果

**实现难度**: 中等（需要修改 API 调用逻辑）

### 方案四：智能重试机制

**原理**: 请求失败时自动重试，支持断点续传

**优点**:
- 提高成功率
- 网络波动时更稳定

**实现要点**:
1. 保存生成进度到 localStorage
2. 失败时从上次成功的位置继续
3. 最多重试 3 次

## 推荐配置（针对不同需求）

### 配置 A: 快速预览（10-20 分镜）
- 模型: `gemini-2.5-flash`
- 超时: 5分钟
- 成本: 低
- 质量: 良好

### 配置 B: 标准制作（20-40 分镜）
- 模型: `claude-sonnet-4-5-20250929`
- 超时: 10分钟
- 启用: 分段生成（可选）
- 成本: 中等
- 质量: 优秀

### 配置 C: 精品大作（40-100+ 分镜）⭐
- 模型: `claude-opus-4-5-20251101`
- 超时: 10分钟/批次
- 启用: 分段生成（必须）
- 批次大小: 15个/批
- 成本: 高（但完全满足需求）
- 质量: 顶级

## 当前状态

✅ 已实施:
- 10分钟超时
- 32768 tokens 输出限制
- 改进错误提示
- 界面提示用户生成时间

⏳ 待实施（如需要）:
- 分段生成功能（已编写代码，需集成到主函数）
- 进度显示条
- 流式输出

## 立即可用的解决方案

用户当前就可以通过以下方式获得更好的体验：

1. **使用 Claude Opus 4.5**
   - 在模型选择器中选择 "Claude Opus 4.5 (最强)"
   - 单次可稳定生成 30-40 个高质量分镜

2. **调整分镜数量范围**
   - 首次生成设置 15-25 个分镜
   - 满意后可以再次生成补充分镜

3. **分段处理长剧本**
   - 将剧本分成 2-3 个部分
   - 每部分单独生成分镜
   - 最后手动合并

## 费用估算（参考）

假设剧本 5000 字，生成 50 个分镜：

- Gemini 2.5 Flash: ~$0.10
- Claude Sonnet 4.5: ~$0.30
- Claude Opus 4.5: ~$1.50

**使用分段生成（3批次）**:
- Claude Sonnet 4.5: ~$0.40 (+30%)
- Claude Opus 4.5: ~$2.00 (+35%)

## 下一步行动

如果您需要立即支持大量分镜（>40个），我可以：

1. ✅ 集成已编写的分段生成代码到主函数
2. ✅ 添加进度条显示
3. ✅ 添加"分段模式"开关
4. ⏹️ 实现流式输出（可选）

请告诉我您的需求，我可以继续实施这些优化！
