# AI剧本批量拆解系统 - 版本2开发进度

## 项目信息
- **项目名称**: AI剧本批量拆解系统（多项目管理版）
- **版本**: 2.0
- **开发开始**: 2026-02-07
- **GitHub**: https://github.com/5JjiaLin/01

## 版本管理
- **v1.0-baseline**: 单剧本处理版本（已完成，已上线）
- **v2.0-dev**: 多项目管理 + 两阶段工作流（开发中）

## 核心改动
从单剧本处理 → 多项目管理 + 两阶段工作流

### 阶段一：资产库构建
- 按集上传剧本
- AI提取重要资产（基于剧情重要性）
- 资产去重与合并（AI智能识别 + 用户确认）
- 资产库锁定

### 阶段二：分镜拆解
- 基于完整资产库生成分镜
- 强制引用已有资产
- 分镜-资产关联追踪

## 开发进度

### ✅ 已完成

#### 1. 需求分析与方案设计（2026-02-07）
- [x] 调用专业Plan agent深度分析需求
- [x] 确定技术方案（Flask + SQLite）
- [x] 设计数据库Schema（9张表）
- [x] 设计RESTful API架构
- [x] 设计AI Prompt工程方案

#### 2. Git版本管理（2026-02-07）
- [x] 创建v1.0-baseline标签
- [x] 推送到GitHub远程仓库

#### 3. 后端框架搭建（2026-02-07）
- [x] 创建数据库Schema（schema.sql）
- [x] 创建SQLAlchemy模型（models.py）
- [x] 创建数据库初始化脚本（init_db.py）
- [x] 创建Flask主应用（app.py）
- [x] 实现基础API：
  - [x] 健康检查 GET /api/health
  - [x] 创建项目 POST /api/projects
  - [x] 获取项目列表 GET /api/projects
  - [x] 获取项目详情 GET /api/projects/:id
  - [x] 上传剧集 POST /api/projects/:id/episodes
  - [x] 获取资产列表 GET /api/projects/:id/assets
- [x] 创建API测试脚本（test_api.py）
- [x] 添加后端README文档
- [x] 提交到GitHub (commit: f021400)

#### 4. 后端核心业务逻辑（2026-02-07）
- [x] AI资产提取服务（调用多模型API）
  - [x] 创建ai_service.py（支持Claude/DeepSeek/Gemini/GPT-4）
  - [x] 实现Prompt工程（结构化JSON输出）
  - [x] 实现资产提取API POST /api/episodes/:id/extract-assets
  - [x] 添加提取状态管理（PENDING/ANALYZING/COMPLETED/FAILED）
- [x] 资产去重检测服务（相似度计算）
  - [x] 创建deduplication_service.py
  - [x] 实现名称相似度算法（SequenceMatcher）
  - [x] 实现描述相似度算法（Jaccard）
  - [x] 实现去重检测API GET /api/projects/:id/assets/duplicates
  - [x] 实现资产合并API POST /api/assets/merge
- [x] 项目状态管理
  - [x] 实现状态转换API PUT /api/projects/:id/status
  - [x] 实现资产库快照创建（锁定时自动创建）
  - [x] 实现项目统计API GET /api/projects/:id/statistics
  - [x] 实现快照查询API GET /api/projects/:id/snapshots
- [x] 分镜-资产关联处理（合并时自动转移引用）
- [x] 完善测试脚本（添加AI提取、去重、合并测试）
- [x] 创建.env.example环境变量示例
- [ ] 分镜生成服务（基于资产库约束）

### 🚧 进行中

#### 5. 前端改造
- [ ] 创建项目管理页面（首页）
- [ ] 创建项目详情页（阶段切换）
- [ ] 创建资产上传页面（按集上传）
- [ ] 创建资产去重确认页面（核心功能）
- [ ] 创建资产库查看页面
- [ ] 创建分镜生成页面
- [ ] 创建分镜查看页面
- [ ] 集成后端API调用

### 📋 待开发

#### 6. 分镜生成功能
- [ ] 创建分镜生成服务（storyboard_service.py）
- [ ] 实现基于资产库的分镜生成Prompt
- [ ] 实现分镜生成API POST /api/episodes/:id/generate-storyboard
- [ ] 强制引用已有资产（资产ID约束）
- [ ] 分镜-资产关联自动创建

#### 5. 前端改造
- [ ] 创建项目管理页面（首页）
- [ ] 创建项目详情页（阶段切换）
- [ ] 创建资产上传页面（按集上传）
- [ ] 创建资产去重确认页面（核心功能）
- [ ] 创建资产库查看页面
- [ ] 创建分镜生成页面
- [ ] 创建分镜查看页面
- [ ] 集成后端API调用

#### 6. 导出功能
- [ ] Excel导出（分镜 + 资产）
- [ ] PDF导出（分镜脚本）
- [ ] JSON导出（完整数据）

#### 7. 高级功能
- [ ] 版本管理与快照回滚
- [ ] 批量上传剧集
- [ ] 资产库编辑功能
- [ ] 统计分析面板
- [ ] 错误处理与重试机制

## 技术栈

### 后端
- **框架**: Flask 3.0.0
- **数据库**: SQLite 3
- **ORM**: SQLAlchemy 2.0.25
- **AI模型**: Claude, DeepSeek, Gemini, GPT-4
- **其他**: Flask-CORS, python-dotenv, openpyxl

### 前端（保持不变）
- **框架**: React 18 + TypeScript
- **构建**: Vite
- **状态管理**: (待添加 Zustand)
- **路由**: (待添加 React Router)
- **HTTP**: (待添加 Axios)

### 数据库设计

#### 核心表（9张）
1. **projects** - 项目表
2. **episodes** - 剧集表（按集上传）
3. **assets** - 资产表（角色/道具/场景）
4. **asset_extraction_records** - 资产提取记录（AI识别追踪）
5. **asset_merge_history** - 资产合并历史（审计）
6. **asset_snapshots** - 资产库快照（版本管理）
7. **storyboards** - 分镜表
8. **storyboard_asset_references** - 分镜-资产关联
9. **visual_styles** - 视觉风格

## 下一步计划

### 立即任务（本次会话）
1. 创建AI资产提取服务
2. 实现资产去重检测API
3. 完善项目管理API
4. 创建简单的前端测试页面

### 短期目标（1-2天）
1. 完成后端所有核心API
2. 前端基础页面搭建
3. 跑通完整的资产拆解流程

### 中期目标（1周）
1. 完成分镜生成功能
2. 完成资产库管理
3. 完成导出功能
4. 前后端完整集成

## Git提交记录

### v2.0开发分支
- `v1.0-baseline` - 版本1基线标签
- `f021400` - feat: 添加Flask后端框架 (2026-02-07)
- 待提交 - feat: 完成AI资产提取、去重检测和项目管理API (2026-02-07)

## 注意事项

1. **多模型支持**: 保持Claude/DeepSeek/Gemini/GPT多模型兼容
2. **向后兼容**: v1.0单剧本功能保留
3. **数据迁移**: 考虑提供v1导出数据导入v2功能
4. **性能优化**: 大资产库（100+）时的Token优化
5. **错误处理**: AI调用失败的降级方案

## 相关文档
- [后端README](backend/README.md)
- [数据库Schema](backend/database/schema.sql)
- [GitHub仓库](https://github.com/5JjiaLin/01)
