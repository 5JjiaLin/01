# 分段生成功能使用指南

## ✅ 已实施的功能

### 1. 智能分段生成
- **自动触发**: 当分镜数量超过 25 个时，系统自动启用分段生成模式
- **适用模型**: Claude 和 GPT 模型（Gemini 暂不支持）
- **批次大小**: 每批生成约 15 个分镜

### 2. 实时进度显示
- 显示当前批次进度（如：2/4）
- 显示百分比进度条
- 显示详细状态信息

### 3. 智能衔接
- 自动传递前 3 个分镜作为上下文
- 确保情绪和氛围连贯
- 自动重新编号确保顺序正确

### 4. 严格模板遵守
每个分镜批次都严格遵守以下模板：

#### 图片提示词 (Fusion Prompt) 五模块顺序：
1. [镜头语言与构图]
2. **图一是[主体描述]**
3. **图二是[交互描述]**（如有）
4. [环境背景]
5. [画面属性]

#### 视频提示词 (Motion Prompt) 格式：
- [镜头轨迹]，动作，[图X动作 + 嘴部状态] + [反应] + [环境动态]

#### 严苛禁令：
- ⛔ 禁止脑补剧情
- ⛔ 禁止使用角色名（必须用"图一"、"图二"）
- ⛔ 对白时"嘴唇张合"，旁白时"嘴唇紧闭"
- ⛔ 严格使用资产列表中的名称

## 使用方法

### 方式 1: 自动触发（推荐）

**步骤**：
1. 在"分镜数量范围"设置 > 25 个分镜（例如：10-30）
2. 选择 Claude 或 GPT 模型（如：Claude Sonnet 4.5）
3. 点击"生成分镜表"
4. 系统自动检测并启用分段模式

**示例**：
- 设置：最小 20，最大 40 → 自动分段
- 设置：最小 10，最大 20 → 不分段（单次生成）

### 方式 2: 大量分镜场景

**适用场景**：生成 50+ 甚至 100+ 个分镜

**步骤**：
1. 设置最大分镜数为目标值（如：50、80、100）
2. 选择 Claude Opus 4.5（最强模型）
3. 耐心等待，观察进度条

**预计时间**：
- 50 个分镜（4批）：约 8-12 分钟
- 100 个分镜（7批）：约 15-20 分钟

## 进度条说明

生成过程中，您会看到：

```
正在生成第 2/4 批分镜 (每批约15个)...
进度: 2 / 4                                    50%
████████████████░░░░░░░░░░░░░░░░
```

**阶段说明**：
- 阶段 0: 正在分析剧本结构...
- 阶段 1-N: 正在生成第 X/N 批分镜...

## 衔接机制

### 前文参考
每批分镜生成时，AI 会看到：
```
## 📌 前文分镜参考（保持连贯性）
前面已生成 15 个分镜。最近的分镜：
#13: 李明转身离开
#14: 背景音乐响起
#15: 镜头淡出

**重要**：
1. 你的起始镜头号是 16，请从这个编号开始
2. 确保与前文自然衔接，不要突兀转场
3. 保持情绪和氛围的连贯性
```

这确保了：
- ✅ 分镜编号连续
- ✅ 情节逻辑连贯
- ✅ 情绪氛围一致
- ✅ 不会突兀跳跃

## 模板遵守保证

每个分段请求中都包含完整的模板要求：

### 1. 骨架模版
每个分镜的 fusionPrompt 必须包含5个模块（顺序固定）

### 2. 嘴部逻辑
- 对白："图一嘴唇张合说话"
- 旁白："图一嘴唇紧闭"

### 3. 资产映射
必须使用 @ 标签引用已定义的角色、场景、道具

### 4. 禁止脑补
严格基于剧本片段，不添加原文不存在的情节

## 错误处理

如果某批次失败，会显示：
```
错误: 分段生成在第 3/5 批时失败: API 请求超时
```

**解决方案**：
1. 检查网络连接
2. 减少分镜数量范围
3. 换用更快的模型（Gemini 2.5 Flash）
4. 重新点击"生成分镜表"

## 费用估算

基于剧本 5000 字，生成不同数量分镜的成本：

### 单次生成模式（<25 个分镜）
- Gemini 2.5 Flash: ~$0.05
- Claude Sonnet 4.5: ~$0.15
- Claude Opus 4.5: ~$0.75

### 分段生成模式
- 30 个分镜（2批）：
  - Claude Sonnet 4.5: ~$0.25 (+65%)
  - Claude Opus 4.5: ~$1.25 (+65%)

- 60 个分镜（4批）：
  - Claude Sonnet 4.5: ~$0.50 (+100%)
  - Claude Opus 4.5: ~$2.50 (+100%)

- 100 个分镜（7批）：
  - Claude Sonnet 4.5: ~$0.85 (+200%)
  - Claude Opus 4.5: ~$4.25 (+200%)

**成本增加原因**：每批都需要传递上下文，导致重复内容

## 最佳实践

### 快速预览（10-20 分镜）
- 模型: Gemini 2.5 Flash
- 模式: 单次生成
- 时间: 1-2 分钟
- 成本: 低

### 标准制作（20-40 分镜）
- 模型: Claude Sonnet 4.5
- 模式: 自动分段（如超过25个）
- 时间: 3-5 分钟
- 成本: 中

### 精品大作（50-100+ 分镜）
- 模型: Claude Opus 4.5
- 模式: 分段生成
- 时间: 10-20 分钟
- 成本: 高
- 质量: 顶级

## 注意事项

1. **分段模式仅限 Claude/GPT**
   - Gemini 暂不支持分段模式
   - 如使用 Gemini 且分镜>25，会提示切换模型

2. **进度不会倒退**
   - 进度条只增不减
   - 即使中途出错，已生成的分镜不会丢失

3. **可以随时停止**
   - 如果觉得时间太长，可刷新页面
   - 重新生成时从头开始

4. **反馈优化不使用分段**
   - "优化分镜"功能始终使用单次生成
   - 适合微调已有结果

## 技术细节

### 分割策略
当前使用简单的长度均分策略：
```typescript
剧本长度: 10000 字
目标分镜: 45 个
批次数: 3 批（45 ÷ 15 = 3）

分割:
- 批次 1: 字符 0-3333 → 生成 12-18 个分镜
- 批次 2: 字符 3334-6666 → 生成 12-18 个分镜
- 批次 3: 字符 6667-10000 → 生成 12-18 个分镜
```

### 未来优化（可选）
- 智能分割：基于情节转折点分割
- AI 分割：使用 AI 分析剧本结构后分割
- 流式输出：实时显示生成的分镜

## 故障排除

### Q: 进度条卡在某个阶段
A: 正常现象，AI 正在生成中，耐心等待最多10分钟

### Q: 显示"Gemini 暂不支持分段模式"
A: 切换到 Claude Sonnet 4.5 或其他 Claude/GPT 模型

### Q: 生成的分镜数量不精确
A: 正常现象，AI 会在范围内浮动（如设置12-18，可能生成14或16个）

### Q: 分镜衔接不自然
A: 可使用"反馈优化"功能，输入："请改进第16-20镜的衔接"

## 总结

✅ **已实现**：
- 自动分段生成（>25 个分镜时触发）
- 实时进度条显示
- 智能前文衔接
- 严格模板遵守
- 10分钟超时保护

✅ **优势**：
- 支持 50-100+ 个分镜
- 分批生成不易超时
- 自动重新编号
- 保持剧情连贯

✅ **适用场景**：
- 长剧本（>8000字）
- 大量分镜需求（>40个）
- 精品制作（不限成本）

🎬 **开始使用**: 设置分镜数量 > 25，选择 Claude 模型，点击生成即可！
