# 大量分镜生成优化方案

## 问题
用户需要生成50-60个分镜，但遇到超时错误，且不愿意手动分段上传剧本。

## 已实施的解决方案

### 1. ✅ 动态分段策略
**优化前：**
- 固定每批15个分镜
- 50个分镜 = 4批

**优化后：**
- 根据总数智能调整
- 40个以下：每批15个
- 40个以上：每批10个（更小批次，避免超时）
- 50个分镜 = 5批，每批10个

### 2. ✅ 增加超时时间
- 从10分钟增加到**15分钟**（900秒）
- 给复杂剧本更多生成时间

### 3. ✅ 自动重试机制
- 每批失败后自动重试2次
- 重试间隔2秒
- 提高成功率

### 4. ✅ 降低分段阈值
- 从25个降低到**20个**分镜
- 更早启动分段模式
- 避免单次请求超时

### 5. ✅ 详细进度提示
显示信息：
- 当前批次进度
- 已完成分镜数量
- 预计剩余时间
- 成功/失败状态

示例：
```
✓ 第 3/5 批已完成（10个分镜），累计30个
正在生成第 4/5 批分镜 (已完成30个，预计还需4分钟)...
```

### 6. ✅ 部分成功保护
- 如果中途失败，保留已生成的分镜
- 错误提示中显示已完成数量
- 避免完全失败浪费时间

## 使用建议

### 对于50-60个分镜的剧本

**最佳实践：**
1. ✅ 使用 **Claude Sonnet 4.5**（性价比最高）
2. ✅ 设置范围：50-60个分镜
3. ✅ 系统会自动：
   - 分成5-6批处理
   - 每批10个分镜
   - 总耗时约10-15分钟

**注意事项：**
- 保持网络连接稳定
- 不要关闭浏览器标签页
- 观察进度提示
- 如果某批失败，会自动重试2次

### 如果仍然超时

**方案A：优化剧本**
- 删除冗余描述
- 保留核心对话和情节
- 目标：压缩到关键内容

**方案B：分次生成**
虽然不愿意分段上传，但可以考虑：
1. 第一次：前半部分（1-30个分镜）
2. 第二次：后半部分（31-60个分镜）
3. 手动合并结果

**方案C：使用更快的模型**
- Claude Haiku 4.5（速度最快，但质量略低）
- 适合快速草稿

## 技术参数对比

| 参数 | 优化前 | 优化后 |
|------|--------|--------|
| 分段阈值 | >25个 | >20个 |
| 批次大小 | 固定15个 | 智能10-15个 |
| 超时时间 | 10分钟 | 15分钟 |
| 重试次数 | 0次 | 2次 |
| 进度提示 | 简单 | 详细（含预计时间） |
| 失败保护 | 无 | 保留部分结果 |

## 测试地址

刷新页面后测试：
- http://localhost:3001/
- http://192.168.31.94:3001/

## 预期效果

**生成50个分镜的流程：**
```
1. 正在分析剧本结构...（共5批，每批约10个分镜）
2. 正在生成第 1/5 批分镜...
3. ✓ 第 1/5 批已完成（10个分镜），累计10个
4. 正在生成第 2/5 批分镜 (已完成10个，预计还需8分钟)...
5. ✓ 第 2/5 批已完成（10个分镜），累计20个
   ... (继续)
6. 全部完成！共50个分镜
```

总耗时：约10-15分钟（取决于剧本长度和网络速度）
