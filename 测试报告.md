# 分段生成功能测试指南

## 测试完成情况

### 1. 代码清理 ✅
- 删除了gemini.ts中的重复定义
- 修复了gemini-chunking-final.ts中的转义字符问题
- 将gemini-chunking-final.ts重命名为.txt（这是一个模板文件，不应被编译）
- 修复了类型导入和函数引用问题

### 2. 编译验证 ✅
- TypeScript编译通过（npx tsc --noEmit）
- Vite构建成功（npm run build）
- 没有类型错误或编译错误

### 3. 分段生成功能验证

#### 自动触发条件
分段生成在以下条件下自动启用（在gemini.ts第485行）：
```typescript
const shouldChunk = !feedback && maxShots && maxShots > 25 && (isClaude || isOpenAI);
```

即：
- 没有反馈优化（feedback为空）
- maxShots > 25（分镜数量超过25个）
- 使用Claude或OpenAI模型（不支持Gemini）

#### 测试步骤
1. 启动开发服务器：`npm run dev`
2. 在界面中：
   - 输入一个较长的剧本
   - 设置最大分镜数为30或更高（触发分段）
   - 选择Claude或GPT模型
   - 点击"生成分镜"

#### 预期行为
- 应该看到进度提示，显示"正在分析剧本结构..."
- 然后显示"正在生成第 X/Y 批分镜 (每批约15个)..."
- 每批次生成15个分镜，分多次完成
- 最终所有分镜会被合并并重新编号

#### 代码实现
- 主函数：`services/gemini-chunking.ts` 中的 `generateStoryboardInChunks`
- 每批生成：15个分镜（可在CHUNK_SIZE变量调整）
- 自动分割剧本并保持连贯性
- 支持Claude和OpenAI模型

## 已修复的问题

1. **重复定义**
   - 删除了gemini.ts中808-876行的不完整函数定义
   - 使用gemini-chunking.ts中的完整实现

2. **转义字符**
   - 修复了gemini-chunking-final.ts中的中文反引号
   - 使用Python脚本批量替换了所有转义字符

3. **类型导入**
   - 在gemini.ts顶部添加了generateStoryboardInChunks的导入
   - 修复了函数调用时的参数传递（添加apiKey, baseUrl, callClaude, callOpenAI）

## 注意事项

- gemini-chunking-final.ts.txt 是模板文件，保留用于参考
- 分段模式仅支持Claude和OpenAI模型
- Gemini模型会自动降级为简单分割策略
